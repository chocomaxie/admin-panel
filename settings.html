<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/app.js"></script>
</head>

<body onload="requireAuth(); loadSettings()" class="bg-gray-50">

  <!-- NAVBAR -->
  <div id="navbar"></div>
  <script>
    let navbarLoaded = false;
    
    fetch("./partials/navbar.html")
      .then(res => res.text())
      .then(html => {
        if (navbarLoaded) return;
        navbarLoaded = true;
        
        document.getElementById("navbar").innerHTML = html;
        
        setTimeout(() => {
          const mainWrapper = document.querySelector("main#page-content");
          const pageContent = document.querySelector("#page-content-inner");
          
          if (mainWrapper && pageContent && !pageContent.dataset.moved) {
            mainWrapper.appendChild(pageContent);
            pageContent.style.display = 'block';
            pageContent.dataset.moved = 'true';
          }
          
          const link = document.querySelector('a[href="settings.html"]');
          if (link) {
            link.classList.add("bg-blue-600", "text-white");
            link.classList.remove("hover:bg-gray-100", "text-gray-700");
          }
        }, 50);
      })
      .catch(err => console.error("Navbar load failed:", err));
  </script>

  <!-- PAGE CONTENT -->
  <div id="page-content-inner" style="display: none;">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Settings</h1>
      <p class="text-gray-600 mt-1">Configure your admin panel preferences</p>
    </div>

    <div class="space-y-6">
      <!-- Store Info -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Store Information</h2>
        <form id="storeForm" onsubmit="saveStoreInfo(event)" class="space-y-4">
          <div>
            <label for="storeName" class="block text-sm font-medium text-gray-700 mb-1">Store Name *</label>
            <input type="text" id="storeName" name="storeName" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="logoFile" class="block text-sm font-medium text-gray-700 mb-1">Logo</label>
            <div class="flex items-center gap-4">
              <input type="file" id="logoFile" name="logoFile" accept="image/*" onchange="previewLogo(event)" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div id="logoPreview" class="hidden">
                <img id="logoImg" src="" alt="Logo" class="w-24 h-24 object-contain border rounded-lg">
              </div>
              <div id="currentLogo" class="hidden">
                <img id="currentLogoImg" src="" alt="Current Logo" class="w-24 h-24 object-contain border rounded-lg">
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Or enter logo URL:</p>
            <label for="logoURL" class="sr-only">Logo URL</label>
            <input type="url" id="logoURL" name="logoURL" placeholder="https://..." class="w-full border rounded-lg px-3 py-2 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="supportEmail" class="block text-sm font-medium text-gray-700 mb-1">Support Email *</label>
            <input type="email" id="supportEmail" name="supportEmail" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
            Save Store Info
          </button>
        </form>
      </div>

      <!-- Notifications -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Notifications</h2>
        <form id="notificationsForm" onsubmit="saveNotifications(event)" class="space-y-6">
          <!-- Low Stock Alerts -->
          <div class="border-b border-gray-200 pb-4">
            <h3 class="font-semibold text-gray-700 mb-3">Low Stock Alerts</h3>
            <div class="space-y-3">
              <label class="flex items-center gap-3">
                <input type="checkbox" id="lowStockEmail" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-700">Email notifications</span>
              </label>
              <label class="flex items-center gap-3">
                <input type="checkbox" id="lowStockFCM" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-700">Push notifications (FCM)</span>
              </label>
              <div>
                <label for="lowStockThreshold" class="block text-sm font-medium text-gray-700 mb-1">Threshold</label>
                <input type="number" id="lowStockThreshold" name="lowStockThreshold" min="0" value="5" class="w-32 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="text-sm text-gray-500 ml-2">items</span>
              </div>
            </div>
          </div>

          <!-- New Message Alerts -->
          <div>
            <h3 class="font-semibold text-gray-700 mb-3">New Message Alerts</h3>
            <div class="space-y-3">
              <label class="flex items-center gap-3">
                <input type="checkbox" id="messageEmail" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-700">Email notifications</span>
              </label>
              <label class="flex items-center gap-3">
                <input type="checkbox" id="messageFCM" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-700">Push notifications (FCM)</span>
              </label>
            </div>
          </div>

          <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
            Save Notification Settings
          </button>
        </form>
      </div>

      <!-- Supabase Configuration -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Supabase Integration</h2>
        <form id="supabaseForm" onsubmit="saveSupabaseConfig(event)" class="space-y-4">
          <div>
            <label for="supabaseURL" class="block text-sm font-medium text-gray-700 mb-1">Supabase URL *</label>
            <input type="url" id="supabaseURL" name="supabaseURL" required placeholder="https://xxxxx.supabase.co" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="supabaseKey" class="block text-sm font-medium text-gray-700 mb-1">Supabase Anon Key *</label>
            <div class="flex items-center gap-2">
              <input type="password" id="supabaseKey" name="supabaseKey" required placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <button type="button" onclick="toggleKeyVisibility()" class="px-3 py-2 border rounded-lg hover:bg-gray-50" aria-label="Toggle key visibility">
                üëÅÔ∏è
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Used for image storage and database operations</p>
          </div>
          <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
            Save Supabase Config
          </button>
        </form>
      </div>

      <!-- Payment/Integrations -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Payment & Integrations</h2>
        <div class="space-y-4">
          <div>
            <label for="paymentKey" class="block text-sm font-medium text-gray-700 mb-1">Payment Gateway API Key</label>
            <div class="flex items-center gap-2">
              <input type="password" id="paymentKey" name="paymentKey" placeholder="sk_live_xxxxx" class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <button type="button" onclick="togglePaymentKeyVisibility()" class="px-3 py-2 border rounded-lg hover:bg-gray-50" aria-label="Toggle payment key visibility">
                üëÅÔ∏è
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Masked for security</p>
          </div>
          <button onclick="savePaymentKey()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
            Save Payment Key
          </button>
        </div>
      </div>

      <!-- Backup/Export -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Backup & Export</h2>
        <div class="space-y-4">
          <div class="flex gap-3">
            <button onclick="exportData()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
              Export All Data (CSV)
            </button>
            <button onclick="backupDatabase()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
              Backup Database
            </button>
          </div>
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <p class="text-sm text-yellow-800">
              <strong>Note:</strong> Manual backup recommended before major updates. Export includes all components, orders, users, and settings.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer"></div>
  <script>
    fetch("./partials/footer.html")
      .then(res => res.text())
      .then(html => document.getElementById("footer").innerHTML = html)
      .catch(err => console.error("Footer load failed:", err));
  </script>

  <script>
    async function loadSettings() {
      try {
        // Load from localStorage or API
        const settings = JSON.parse(localStorage.getItem("adminSettings") || "{}");
        
        if (settings.storeName) document.getElementById("storeName").value = settings.storeName;
        if (settings.logoURL) {
          document.getElementById("logoURL").value = settings.logoURL;
          document.getElementById("currentLogoImg").src = settings.logoURL;
          document.getElementById("currentLogo").classList.remove("hidden");
        }
        if (settings.supportEmail) document.getElementById("supportEmail").value = settings.supportEmail;

        // Notifications
        if (settings.lowStockEmail !== undefined) document.getElementById("lowStockEmail").checked = settings.lowStockEmail;
        if (settings.lowStockFCM !== undefined) document.getElementById("lowStockFCM").checked = settings.lowStockFCM;
        if (settings.lowStockThreshold) document.getElementById("lowStockThreshold").value = settings.lowStockThreshold;
        if (settings.messageEmail !== undefined) document.getElementById("messageEmail").checked = settings.messageEmail;
        if (settings.messageFCM !== undefined) document.getElementById("messageFCM").checked = settings.messageFCM;

        // Supabase
        const supabaseUrl = localStorage.getItem("supabase_url");
        const supabaseKey = localStorage.getItem("supabase_key");
        if (supabaseUrl) document.getElementById("supabaseURL").value = supabaseUrl;
        if (supabaseKey) document.getElementById("supabaseKey").value = supabaseKey;

        // Payment
        if (settings.paymentKey) {
          const masked = maskKey(settings.paymentKey);
          document.getElementById("paymentKey").value = masked;
        }
      } catch (error) {
        console.error("Failed to load settings:", error);
      }
    }

    async function saveStoreInfo(event) {
      event.preventDefault();
      try {
        const logoFile = document.getElementById("logoFile").files[0];
        let logoURL = document.getElementById("logoURL").value;

        if (logoFile) {
          // Assuming uploadImage function exists in app.js
          if (typeof uploadImage === 'function') {
            logoURL = await uploadImage(logoFile, "logos");
          } else {
            showToast("Image upload not configured", "error");
            return;
          }
        }

        const settings = {
          storeName: document.getElementById("storeName").value,
          logoURL: logoURL || document.getElementById("logoURL").value,
          supportEmail: document.getElementById("supportEmail").value
        };

        localStorage.setItem("adminSettings", JSON.stringify({ ...JSON.parse(localStorage.getItem("adminSettings") || "{}"), ...settings }));
        showToast("Store information saved");
      } catch (error) {
        console.error("Save error:", error);
        showToast("Failed to save store information", "error");
      }
    }

    function saveNotifications(event) {
      event.preventDefault();
      const settings = {
        lowStockEmail: document.getElementById("lowStockEmail").checked,
        lowStockFCM: document.getElementById("lowStockFCM").checked,
        lowStockThreshold: parseInt(document.getElementById("lowStockThreshold").value) || 5,
        messageEmail: document.getElementById("messageEmail").checked,
        messageFCM: document.getElementById("messageFCM").checked
      };

      localStorage.setItem("adminSettings", JSON.stringify({ ...JSON.parse(localStorage.getItem("adminSettings") || "{}"), ...settings }));
      showToast("Notification settings saved");
    }

    function saveSupabaseConfig(event) {
      event.preventDefault();
      const url = document.getElementById("supabaseURL").value;
      const key = document.getElementById("supabaseKey").value;

      // Save to localStorage
      localStorage.setItem("supabase_url", url);
      localStorage.setItem("supabase_key", key);

      // Try to initialize if function exists
      if (typeof initSupabase === 'function') {
        if (initSupabase(url, key)) {
          showToast("Supabase configuration saved");
        } else {
          showToast("Failed to initialize Supabase. Please check your credentials.", "error");
        }
      } else {
        showToast("Supabase configuration saved");
      }
    }

    function savePaymentKey() {
      const key = document.getElementById("paymentKey").value;
      const settings = JSON.parse(localStorage.getItem("adminSettings") || "{}");
      settings.paymentKey = key;
      localStorage.setItem("adminSettings", JSON.stringify(settings));
      showToast("Payment key saved");
    }

    function previewLogo(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("logoImg").src = e.target.result;
          document.getElementById("logoPreview").classList.remove("hidden");
          document.getElementById("currentLogo").classList.add("hidden");
        };
        reader.readAsDataURL(file);
      }
    }

    function toggleKeyVisibility() {
      const input = document.getElementById("supabaseKey");
      input.type = input.type === "password" ? "text" : "password";
    }

    function togglePaymentKeyVisibility() {
      const input = document.getElementById("paymentKey");
      input.type = input.type === "password" ? "text" : "password";
    }

    function maskKey(key) {
      if (!key || key.length < 8) return key;
      return key.substring(0, 4) + "..." + key.substring(key.length - 4);
    }

    async function exportData() {
      try {
        showToast("Exporting data...", "info");
        
        // Check if api function exists
        if (typeof api !== 'function') {
          showToast("API not configured", "error");
          return;
        }

        const [components, orders, users] = await Promise.allSettled([
          api().get("/componentsadmin"),
          api().get("/orders"),
          api().get("/users")
        ]);

        const data = {
          components: components.status === "fulfilled" ? (components.value.data?.data || components.value.data) : [],
          orders: orders.status === "fulfilled" ? (orders.value.data?.data || orders.value.data) : [],
          users: users.status === "fulfilled" ? (users.value.data?.data || users.value.data) : [],
          exportDate: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `backup_${new Date().toISOString().split("T")[0]}.json`;
        a.click();
        window.URL.revokeObjectURL(url);
        showToast("Data exported successfully");
      } catch (error) {
        console.error("Export error:", error);
        showToast("Failed to export data", "error");
      }
    }

    async function backupDatabase() {
      try {
        showToast("Creating backup...", "info");
        await exportData();
      } catch (error) {
        console.error("Backup error:", error);
        showToast("Failed to create backup", "error");
      }
    }

    // Helper functions if not defined in app.js
    if (typeof showToast !== 'function') {
      window.showToast = function(message, type = 'success') {
        alert(message);
      };
    }

    if (typeof handleApiError !== 'function') {
      window.handleApiError = function(error) {
        console.error("API Error:", error);
        showToast(error.message || "An error occurred", "error");
      };
    }
  </script>

</body>
</html>