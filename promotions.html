<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promotions - Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="js/app.js"></script>
</head>

<body onload="requireAuth(); loadPromotions()" class="bg-gray-50">

  <!-- NAVBAR -->
  <div id="navbar"></div>
  <script>
    let navbarLoaded = false;
    
    fetch("./partials/navbar.html")
      .then(res => res.text())
      .then(html => {
        if (navbarLoaded) return;
        navbarLoaded = true;
        
        document.getElementById("navbar").innerHTML = html;
        
        setTimeout(() => {
          const mainWrapper = document.querySelector("main#page-content");
          const pageContent = document.querySelector("#page-content-inner");
          
          if (mainWrapper && pageContent && !pageContent.dataset.moved) {
            mainWrapper.appendChild(pageContent);
            pageContent.style.display = 'block';
            pageContent.dataset.moved = 'true';
          }
          
          const link = document.querySelector('a[href="promotions.html"]');
          if (link) {
            link.classList.add("bg-blue-600", "text-white");
            link.classList.remove("hover:bg-gray-100", "text-gray-700");
          }
        }, 50);
      })
      .catch(err => console.error("Navbar load failed:", err));
  </script>

  <!-- PAGE CONTENT -->
  <div id="page-content-inner" style="display: none;">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Promotions</h1>
        <p class="text-gray-600 mt-1">Manage discounts and special offers</p>
      </div>
      <button onclick="openAddPromo()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
        ＋ New Promotion
      </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label for="statusFilter" class="sr-only">Filter by Status</label>
          <select id="statusFilter" name="statusFilter" onchange="filterPromotions()" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="scheduled">Scheduled</option>
            <option value="inactive">Inactive</option>
            <option value="expired">Expired</option>
          </select>
        </div>
        <div>
          <label for="typeFilter" class="sr-only">Filter by Type</label>
          <select id="typeFilter" name="typeFilter" onchange="filterPromotions()" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Types</option>
            <option value="percent">Percent</option>
            <option value="fixed">Fixed</option>
          </select>
        </div>
        <div>
          <label for="searchPromo" class="sr-only">Search Promotions</label>
          <input type="text" id="searchPromo" name="searchPromo" placeholder="Search promotions…" onkeyup="filterPromotions()" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>
    </div>

    <!-- Promotions Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="p-3 text-left text-xs font-medium text-gray-600">Name</th>
              <th class="p-3 text-left text-xs font-medium text-gray-600">Type</th>
              <th class="p-3 text-left text-xs font-medium text-gray-600">Value</th>
              <th class="p-3 text-left text-xs font-medium text-gray-600">Applies To</th>
              <th class="p-3 text-left text-xs font-medium text-gray-600">Start</th>
              <th class="p-3 text-left text-xs font-medium text-gray-600">End</th>
              <th class="p-3 text-left text-xs font-medium text-gray-600">Status</th>
              <th class="p-3 text-left text-xs font-medium text-gray-600">Actions</th>
            </tr>
          </thead>
          <tbody id="promotionsTable" class="divide-y divide-gray-200">
            <tr><td colspan="8" class="p-8 text-center text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Promotion Modal -->
  <div id="promoModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 id="promoModalTitle" class="text-2xl font-bold text-gray-800">New Promotion</h2>
        <button onclick="closePromoModal()" class="text-gray-400 hover:text-gray-600 text-2xl">×</button>
      </div>

      <form id="promoForm" onsubmit="savePromo(event)" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="promoName" class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
            <input type="text" id="promoName" name="promoName" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Summer Sale">
          </div>

          <div>
            <label for="promoCode" class="block text-sm font-medium text-gray-700 mb-1">Promo Code</label>
            <input type="text" id="promoCode" name="promoCode" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., SUMMER20">
          </div>

          <div>
            <label for="promoType" class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
            <select id="promoType" name="promoType" required onchange="updatePromoType()" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="percent">Percent</option>
              <option value="fixed">Fixed Amount</option>
            </select>
          </div>

          <div>
            <label for="promoValue" class="block text-sm font-medium text-gray-700 mb-1">Value *</label>
            <div class="flex items-center">
              <input type="number" id="promoValue" name="promoValue" required step="0.01" min="0" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <span id="promoValueSuffix" class="ml-2 text-gray-600">%</span>
            </div>
          </div>

          <div>
            <label for="promoScope" class="block text-sm font-medium text-gray-700 mb-1">Scope *</label>
            <select id="promoScope" name="promoScope" required onchange="updatePromoScope()" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="all">All Products</option>
              <option value="type">By Type</option>
              <option value="brand">By Brand</option>
              <option value="specific">Specific IDs</option>
            </select>
          </div>

          <div id="scopeTypeContainer" class="hidden">
            <label for="scopeType" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="scopeType" name="scopeType" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="CPU">CPU</option>
              <option value="GPU">GPU</option>
              <option value="MOBO">MOBO</option>
              <option value="RAM">RAM</option>
              <option value="Storage">Storage</option>
              <option value="PSU">PSU</option>
              <option value="Case">Case</option>
              <option value="Cooling">Cooling</option>
              <option value="Peripheral">Peripheral</option>
            </select>
          </div>

          <div id="scopeBrandContainer" class="hidden">
            <label for="scopeBrand" class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
            <input type="text" id="scopeBrand" name="scopeBrand" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Brand name">
          </div>

          <div id="scopeIdsContainer" class="hidden md:col-span-2">
            <label for="scopeIds" class="block text-sm font-medium text-gray-700 mb-1">Component IDs (comma-separated)</label>
            <input type="text" id="scopeIds" name="scopeIds" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ID1, ID2, ID3">
          </div>

          <div>
            <label for="promoStart" class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
            <input type="datetime-local" id="promoStart" name="promoStart" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label for="promoEnd" class="block text-sm font-medium text-gray-700 mb-1">End Date *</label>
            <input type="datetime-local" id="promoEnd" name="promoEnd" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label for="promoStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="promoStatus" name="promoStatus" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="active">Active</option>
              <option value="scheduled">Scheduled</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          <div>
            <label for="promoMaxUses" class="block text-sm font-medium text-gray-700 mb-1">Max Uses (optional)</label>
            <input type="number" id="promoMaxUses" name="promoMaxUses" min="0" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Unlimited">
          </div>
        </div>

        <div class="md:col-span-2">
          <label for="promoDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="promoDescription" name="promoDescription" rows="3" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Promotion description..."></textarea>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button type="button" onclick="closePromoModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition">Cancel</button>
          <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer"></div>
  <script>
    fetch("./partials/footer.html")
      .then(res => res.text())
      .then(html => document.getElementById("footer").innerHTML = html)
      .catch(err => console.error("Footer load failed:", err));
  </script>

  <script>
    let allPromotions = [];
    let filteredPromotions = [];
    let editPromoId = null;

    async function loadPromotions() {
      try {
        showLoading(document.getElementById("promotionsTable"));
        
        const res = await api().get("/promotions");
        allPromotions = res.data?.data || res.data || [];
        
        filterPromotions();
      } catch (error) {
        console.error("Failed to load promotions:", error);
        handleApiError(error);
        document.getElementById("promotionsTable").innerHTML = 
          '<tr><td colspan="8" class="p-8 text-center text-red-500">Failed to load promotions</td></tr>';
      }
    }

    function filterPromotions() {
      const statusFilter = document.getElementById("statusFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const search = document.getElementById("searchPromo").value.toLowerCase();

      filteredPromotions = allPromotions.filter(promo => {
        const now = new Date();
        const start = new Date(promo.start_date || promo.startDate);
        const end = new Date(promo.end_date || promo.endDate);
        let status = promo.status || "inactive";
        
        if (status === "scheduled" && now >= start && now <= end) {
          status = "active";
        } else if (now > end) {
          status = "expired";
        }

        const matchStatus = !statusFilter || status === statusFilter;
        const matchType = !typeFilter || (promo.type || promo.discount_type) === typeFilter;
        const matchSearch = !search || 
          (promo.name || "").toLowerCase().includes(search) ||
          (promo.code || promo.promo_code || "").toLowerCase().includes(search);

        return matchStatus && matchType && matchSearch;
      });

      renderTable();
    }

    function renderTable() {
      if (filteredPromotions.length === 0) {
        document.getElementById("promotionsTable").innerHTML = 
          '<tr><td colspan="8" class="p-8 text-center text-gray-500">No promotions found</td></tr>';
        return;
      }

      document.getElementById("promotionsTable").innerHTML = filteredPromotions.map(promo => {
        const now = new Date();
        const start = new Date(promo.start_date || promo.startDate);
        const end = new Date(promo.end_date || promo.endDate);
        let status = promo.status || "inactive";
        
        if (status === "scheduled" && now >= start && now <= end) {
          status = "active";
        } else if (now > end) {
          status = "expired";
        }

        const type = promo.type || promo.discount_type || "percent";
        const value = promo.value || promo.discount_value || 0;
        const scope = promo.scope || promo.applies_to || "all";
        const scopeValue = promo.scope_value || promo.scopeValue || "";

        const appliesTo = scope === "all" ? "All Products" :
          scope === "type" ? `Type: ${scopeValue}` :
          scope === "brand" ? `Brand: ${scopeValue}` :
          `IDs: ${scopeValue}`;

        return `
          <tr class="hover:bg-gray-50">
            <td class="p-3 text-sm font-medium">
              ${promo.name}
              ${promo.code || promo.promo_code ? `<div class="text-xs text-gray-500 font-mono">${promo.code || promo.promo_code}</div>` : ''}
            </td>
            <td class="p-3 text-sm">${type === "percent" ? "Percent" : "Fixed"}</td>
            <td class="p-3 text-sm font-semibold text-green-600">${type === "percent" ? `${value}%` : formatCurrency(value)}</td>
            <td class="p-3 text-sm text-gray-600">${appliesTo}</td>
            <td class="p-3 text-xs">${formatDate(start)}</td>
            <td class="p-3 text-xs">${formatDate(end)}</td>
            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs ${
                status === "active" ? "bg-green-100 text-green-700" :
                status === "scheduled" ? "bg-blue-100 text-blue-700" :
                status === "expired" ? "bg-gray-100 text-gray-700" :
                "bg-red-100 text-red-700"
              }">${status.toUpperCase()}</span>
            </td>
            <td class="p-3">
              <div class="flex gap-2">
                <button onclick="editPromo('${promo.id || promo._id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                <button onclick="duplicatePromo('${promo.id || promo._id}')" class="text-green-600 hover:underline text-xs">Dup</button>
                ${status !== "expired" ? `
                  <button onclick="togglePromoStatus('${promo.id || promo._id}', '${status}')" class="text-orange-600 hover:underline text-xs">
                    ${status === "active" ? "Deactivate" : "Activate"}
                  </button>
                ` : ''}
                <button onclick="deletePromo('${promo.id || promo._id}')" class="text-red-600 hover:underline text-xs">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    function openAddPromo() {
      editPromoId = null;
      document.getElementById("promoForm").reset();
      document.getElementById("promoModalTitle").textContent = "New Promotion";
      
      // Set default dates
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const nextWeek = new Date(now);
      nextWeek.setDate(nextWeek.getDate() + 7);
      
      document.getElementById("promoStart").value = now.toISOString().slice(0, 16);
      document.getElementById("promoEnd").value = nextWeek.toISOString().slice(0, 16);
      
      updatePromoType();
      updatePromoScope();
      document.getElementById("promoModal").classList.remove("hidden");
    }

    function updatePromoType() {
      const type = document.getElementById("promoType").value;
      document.getElementById("promoValueSuffix").textContent = type === "percent" ? "%" : "₱";
    }

    function updatePromoScope() {
      const scope = document.getElementById("promoScope").value;
      document.getElementById("scopeTypeContainer").classList.toggle("hidden", scope !== "type");
      document.getElementById("scopeBrandContainer").classList.toggle("hidden", scope !== "brand");
      document.getElementById("scopeIdsContainer").classList.toggle("hidden", scope !== "specific");
    }

    async function savePromo(event) {
      event.preventDefault();
      
      try {
        const scope = document.getElementById("promoScope").value;
        let scopeValue = "";
        
        if (scope === "type") {
          scopeValue = document.getElementById("scopeType").value;
        } else if (scope === "brand") {
          scopeValue = document.getElementById("scopeBrand").value;
        } else if (scope === "specific") {
          scopeValue = document.getElementById("scopeIds").value;
        }

        const promoData = {
          name: document.getElementById("promoName").value,
          code: document.getElementById("promoCode").value || null,
          promo_code: document.getElementById("promoCode").value || null,
          type: document.getElementById("promoType").value,
          discount_type: document.getElementById("promoType").value,
          value: parseFloat(document.getElementById("promoValue").value),
          discount_value: parseFloat(document.getElementById("promoValue").value),
          scope: scope,
          applies_to: scope,
          scope_value: scopeValue,
          scopeValue: scopeValue,
          start_date: new Date(document.getElementById("promoStart").value).toISOString(),
          startDate: new Date(document.getElementById("promoStart").value).toISOString(),
          end_date: new Date(document.getElementById("promoEnd").value).toISOString(),
          endDate: new Date(document.getElementById("promoEnd").value).toISOString(),
          status: document.getElementById("promoStatus").value,
          max_uses: parseInt(document.getElementById("promoMaxUses").value) || null,
          description: document.getElementById("promoDescription").value || null
        };

        if (editPromoId) {
          await api().put(`/promotions/${editPromoId}`, promoData);
          showToast("Promotion updated");
        } else {
          await api().post("/promotions", promoData);
          showToast("Promotion created");
        }

        closePromoModal();
        loadPromotions();
      } catch (error) {
        handleApiError(error);
      }
    }

    async function editPromo(id) {
      try {
        editPromoId = id;
        const res = await api().get(`/promotions/${id}`);
        const promo = res.data?.data || res.data;

        document.getElementById("promoName").value = promo.name || "";
        document.getElementById("promoCode").value = promo.code || promo.promo_code || "";
        document.getElementById("promoType").value = promo.type || promo.discount_type || "percent";
        document.getElementById("promoValue").value = promo.value || promo.discount_value || "";
        document.getElementById("promoScope").value = promo.scope || promo.applies_to || "all";
        document.getElementById("promoStatus").value = promo.status || "active";
        document.getElementById("promoMaxUses").value = promo.max_uses || "";
        document.getElementById("promoDescription").value = promo.description || "";
        
        const startDate = new Date(promo.start_date || promo.startDate);
        const endDate = new Date(promo.end_date || promo.endDate);
        document.getElementById("promoStart").value = startDate.toISOString().slice(0, 16);
        document.getElementById("promoEnd").value = endDate.toISOString().slice(0, 16);

        const scopeValue = promo.scope_value || promo.scopeValue || "";
        const scope = promo.scope || promo.applies_to || "all";
        
        if (scope === "type") {
          document.getElementById("scopeType").value = scopeValue;
        } else if (scope === "brand") {
          document.getElementById("scopeBrand").value = scopeValue;
        } else if (scope === "specific") {
          document.getElementById("scopeIds").value = scopeValue;
        }

        updatePromoType();
        updatePromoScope();
        document.getElementById("promoModalTitle").textContent = "Edit Promotion";
        document.getElementById("promoModal").classList.remove("hidden");
      } catch (error) {
        handleApiError(error);
      }
    }

    async function duplicatePromo(id) {
      try {
        const res = await api().get(`/promotions/${id}`);
        const promo = res.data?.data || res.data;
        
        const copyData = {
          name: (promo.name || "") + " (Copy)",
          code: null,
          type: promo.type || promo.discount_type,
          value: promo.value || promo.discount_value,
          scope: promo.scope || promo.applies_to,
          scope_value: promo.scope_value || promo.scopeValue,
          start_date: new Date().toISOString(),
          end_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
          status: "inactive",
          max_uses: promo.max_uses,
          description: promo.description
        };
        
        await api().post("/promotions", copyData);
        showToast("Promotion duplicated");
        loadPromotions();
      } catch (error) {
        handleApiError(error);
      }
    }

    async function togglePromoStatus(id, currentStatus) {
      try {
        const newStatus = currentStatus === "active" ? "inactive" : "active";
        await api().put(`/promotions/${id}`, { status: newStatus });
        showToast(`Promotion ${newStatus === "active" ? "activated" : "deactivated"}`);
        loadPromotions();
      } catch (error) {
        handleApiError(error);
      }
    }

    async function deletePromo(id) {
      if (confirm("Delete this promotion? This action cannot be undone.")) {
        try {
          await api().delete(`/promotions/${id}`);
          showToast("Promotion deleted");
          loadPromotions();
        } catch (error) {
          handleApiError(error);
        }
      }
    }

    function closePromoModal() {
      document.getElementById("promoModal").classList.add("hidden");
      editPromoId = null;
    }
  </script>

</body>
</html>